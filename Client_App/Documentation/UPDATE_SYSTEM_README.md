# Система проверки обновлений МПЗФ

## Обзор

Система автоматически проверяет наличие обновлений программы МПЗФ через сайт norao.ru и уведомляет пользователей о новых версиях.

## Как работает

### Для обычных пользователей
- **Автоматическая проверка** при запуске программы (не чаще 1 раза в день)
- **Ненавязчивое уведомление** о доступной новой версии
- **Прямая ссылка** на страницу загрузки
- **Возможность пропустить** версию или напомнить позже

### Для отдела (режим разработчика)
- Те же функции, что и для обычных пользователей
- Возможность добавления автообновления из сетевой папки

## Компоненты системы

### 1. UpdateChecker.cs
- Парсит версию с сайта https://www.norao.ru/sguk/software/mpzf/
- Определяет текущую версию приложения
- Возвращает информацию о доступном обновлении

### 2. UpdateService.cs
- Управляет логикой проверок
- Учитывает пропущенные версии
- Показывает диалоговые окна
- Проверяет не чаще 1 раза в день

### 3. UpdateNotificationWindow.axaml/.cs
- Окно уведомления об обновлении
- Кнопки: "Скачать", "Напомнить позже", "Пропустить версию"
- Красивый интерфейс с информацией о версиях

### 4. UpdateNotificationViewModel.cs
- ViewModel для окна уведомления
- Команды для действий пользователя
- Сохранение пропущенных версий

### 5. Настройки в Settings.settings
- `SkippedVersion` - пропущенная версия
- `LastUpdateCheck` - время последней проверки

## Интеграция в MainWindowVM

```csharp
// Инициализация в конструкторе
_updateService = new UpdateService();

// Фоновая проверка обновлений
_ = Task.Run(async () => await _updateService.CheckAndNotifyAsync(AppLaunchedAtNorao));
```

## Порядок парсинга версии

Система ищет на странице текст:
```
"Актуальная версия МПЗФ, рекомендуемая для загрузки и установки - 1.3.0.3 от 29.12.2025"
```

И извлекает:
- Версия: `1.3.0.3`
- Дата: `29.12.2025`

## Обработка ошибок

- **Нет интернета** - проверка молча пропускается
- **Сайт недоступен** - проверка молча пропускается
- **Ошибка парсинга** - проверка молча пропускается
- **Ошибка открытия браузера** - логируется, но не блокирует интерфейс

## Безопасность

- Проверка только для чтения - никаких изменений в системе
- Пользователь сам решает, обновляться или нет
- Никакой автоматической загрузки или установки
- Пропущенные версии сохраняются локально

## Расширение для отдела

Можно добавить автообновление из сетевой папки:
```csharp
if (isDeveloperMode)
{
    await ShowAutoUpdateDialog(updateInfo);
}
```

## Тестирование

Для тестирования можно временно изменить URL на локальный файл или изменить текущую версию приложения.

## Логирование

Ошибки записываются в Debug.WriteLine для отладки.
